const { decrypt, convertDateTime, dateconvert, convertDate } = require('@triyogagp/backend-common/utils/helper.utils');
const {
	_allOptionCms,
	_agamaOption,
  _citacitaOption,
	_hobiOption,
	_jenjangsekolahOption,
	_statussekolahOption,
	_statusortuOption,
	_pendidikanOption,
	_pekerjaanOption,
	_jabatanOption,
	_mengajarOption,
	_penghasilanOption,
	_statustempattinggalOption,
	_jarakrumahOption,
	_transportasiOption,
	// _wilayahOption,
	_wilayah2023Option,
} = require('../controllers/helper.service')
const dotenv = require('dotenv');
dotenv.config();
const BASE_URL = process.env.BASE_URL

async function _buildResponseUser(dataUser, refreshToken, accessToken, models) {
	return {
		idUser: dataUser.idUser,
		consumerType: dataUser.consumerType,
		namaRole: dataUser.Role.namaRole,
		nama: dataUser.nama,
		username: dataUser.username,
		email: dataUser.email,
		password: dataUser.password,
		kataSandi: dataUser.kataSandi,
		tempat: dataUser.UserDetail.tempat,
		tanggalLahir: dataUser.UserDetail.tanggalLahir,
		jenisKelamin: dataUser.UserDetail.jenisKelamin,
		agama: await _allOptionCms(models, { where: { kode: 'agama' } }, { param: dataUser.UserDetail.agama }),
		telp: dataUser.UserDetail.telp,
		alamat: dataUser.UserDetail.alamat,
		provinsi: await _wilayah2023Option({ models, kode: dataUser.UserDetail.provinsi, bagian: 'provinsi' }),
		kabKota: await _wilayah2023Option({ models, kode: dataUser.UserDetail.kabKota, bagian: 'kabkota' }),
		kecamatan: await _wilayah2023Option({ models, kode: dataUser.UserDetail.kecamatan, bagian: 'kecamatan' }),
		kelurahan: await _wilayah2023Option({ models, kode: dataUser.UserDetail.kelurahan, bagian: 'keldes' }),
		kodePos: dataUser.UserDetail.kodePos,
		jabatanGuru: dataUser.UserDetail.jabatanGuru,
		mengajarBidang: dataUser.UserDetail.mengajarBidang,
		mengajarKelas: dataUser.UserDetail.mengajarKelas,
		waliKelas: dataUser.UserDetail.waliKelas,
		kelas: dataUser.UserDetail.kelas,
		fotoProfil: dataUser.UserDetail.fotoProfil ? `${BASE_URL}image/${dataUser.UserDetail.fotoProfil}` : `${BASE_URL}bahan/user.png`,
		isActive: dataUser.isActive,
		statusAktif: dataUser.statusAktif,
		refreshToken,
		accessToken
	}
}

async function _buildResponseAdmin(models, dataAdmin) {
	return {
		idUser: dataAdmin.idUser,
		consumerType: dataAdmin.consumerType,
		namaRole: dataAdmin.Role.namaRole,
		nama: dataAdmin.nama,
		username: dataAdmin.username,
		email: dataAdmin.email,
		password: dataAdmin.password,
		kataSandi: dataAdmin.kataSandi,
		tempat: dataAdmin.UserDetail.tempat,
		tanggalLahir: dataAdmin.UserDetail.tanggalLahir,
		jenisKelamin: dataAdmin.UserDetail.jenisKelamin,
		agama: await _allOptionCms(models, { where: { kode: 'agama' } }, { param: dataAdmin.UserDetail.agama }),
		telp: dataAdmin.UserDetail.telp,
		alamat: dataAdmin.UserDetail.alamat,
		provinsi: await _wilayah2023Option({ models, kode: dataAdmin.UserDetail.provinsi, bagian: 'provinsi' }),
		kabKota: await _wilayah2023Option({ models, kode: dataAdmin.UserDetail.kabKota, bagian: 'kabkota' }),
		kecamatan: await _wilayah2023Option({ models, kode: dataAdmin.UserDetail.kecamatan, bagian: 'kecamatan' }),
		kelurahan: await _wilayah2023Option({ models, kode: dataAdmin.UserDetail.kelurahan, bagian: 'keldes' }),
		kodePos: dataAdmin.UserDetail.kodePos,
		fotoProfil: dataAdmin.UserDetail.fotoProfil ? `${BASE_URL}image/${dataAdmin.UserDetail.fotoProfil}` : `${BASE_URL}bahan/user.png`,
		isActive: dataAdmin.isActive,
		statusAktif: dataAdmin.statusAktif,
	}
}

async function _buildResponseStruktural(models, dataStruktural) {
	return {
		idUser: dataStruktural.idUser,
		consumerType: dataStruktural.consumerType,
		nomorInduk: dataStruktural.UserDetail.nomorInduk,
		namaRole: dataStruktural.Role.namaRole,
		nama: dataStruktural.nama,
		username: dataStruktural.username,
		email: dataStruktural.email,
		password: dataStruktural.password,
		kataSandi: dataStruktural.kataSandi,
		tempat: dataStruktural.UserDetail.tempat,
		tanggalLahir: dataStruktural.UserDetail.tanggalLahir,
		jenisKelamin: dataStruktural.UserDetail.jenisKelamin,
		agama: await _allOptionCms(models, { where: { kode: 'agama' } }, { param: dataStruktural.UserDetail.agama }),
		telp: dataStruktural.UserDetail.telp,
		alamat: dataStruktural.UserDetail.alamat,
		provinsi: await _wilayah2023Option({ models, kode: dataStruktural.UserDetail.provinsi, bagian: 'provinsi' }),
		kabKota: await _wilayah2023Option({ models, kode: dataStruktural.UserDetail.kabKota, bagian: 'kabkota' }),
		kecamatan: await _wilayah2023Option({ models, kode: dataStruktural.UserDetail.kecamatan, bagian: 'kecamatan' }),
		kelurahan: await _wilayah2023Option({ models, kode: dataStruktural.UserDetail.kelurahan, bagian: 'keldes' }),
		kodePos: dataStruktural.UserDetail.kodePos,
		pendidikanGuru: await _allOptionCms(models, { where: { kode: 'pendidikan' } }, { param: dataStruktural.UserDetail.pendidikanGuru }),
		jabatanGuru: dataStruktural.UserDetail.jabatanGuru ? await _allOptionCms(models, { where: { kode: 'jabatan' } }, { param: dataStruktural.UserDetail.jabatanGuru }) : null,
		mengajarBidang: dataStruktural.UserDetail.mengajarBidang ? await _allOptionCms(models, { where: { kode: 'mengajar' } }, { param: dataStruktural.UserDetail.mengajarBidang }) : null,
		mengajarKelas: dataStruktural?.UserDetail?.mengajarKelas?.split(', '),
		waliKelas: dataStruktural.UserDetail.waliKelas,
		fotoProfil: dataStruktural.UserDetail.fotoProfil ? `${BASE_URL}image/${dataStruktural.UserDetail.fotoProfil}` : `${BASE_URL}bahan/user.png`,
		isActive: dataStruktural.isActive,
		statusAktif: dataStruktural.statusAktif,
	}
}

async function _buildResponseSiswaSiswi(models, dataSiswaSiswi) {
	const mapel = await _allOptionCms(models, { where: { kode: 'mengajar' } })
	return {
		idUser: dataSiswaSiswi.idUser,
		consumerType: dataSiswaSiswi.consumerType,
		nikSiswa: dataSiswaSiswi.UserDetail.nikSiswa,
		nomorInduk: dataSiswaSiswi.UserDetail.nomorInduk,
		namaRole: dataSiswaSiswi.Role.namaRole,
		nama: dataSiswaSiswi.nama,
		username: dataSiswaSiswi.username,
		email: dataSiswaSiswi.email,
		password: dataSiswaSiswi.password,
		kataSandi: dataSiswaSiswi.kataSandi,
		tempat: dataSiswaSiswi.UserDetail.tempat,
		tanggalLahir: dataSiswaSiswi.UserDetail.tanggalLahir,
		jenisKelamin: dataSiswaSiswi.UserDetail.jenisKelamin,
		agama: await _allOptionCms(models, { where: { kode: 'agama' } }, { param: dataSiswaSiswi.UserDetail.agama }),
		anakKe: dataSiswaSiswi.UserDetail.anakKe,
		jumlahSaudara: dataSiswaSiswi.UserDetail.jumlahSaudara,
		hobi: dataSiswaSiswi.UserDetail.hobi ? await _allOptionCms(models, { where: { kode: 'hobi' } }, { param: dataSiswaSiswi.UserDetail.hobi }) : null,
		citaCita: dataSiswaSiswi.UserDetail.citaCita ? await _allOptionCms(models, { where: { kode: 'citacita' } }, { param: dataSiswaSiswi.UserDetail.citaCita }) : null,
		dataSekolahSebelumnya: {
			jenjang: await _allOptionCms(models, { where: { kode: 'jenjangsekolah' } }, { param: dataSiswaSiswi.UserDetail.jenjang }),
			statusSekolah: await _allOptionCms(models, { where: { kode: 'status_sekolah' } }, { param: dataSiswaSiswi.UserDetail.statusSekolah }),
			namaSekolah: dataSiswaSiswi.UserDetail.namaSekolah,
			npsn: dataSiswaSiswi.UserDetail.npsn,
			alamatSekolah: dataSiswaSiswi.UserDetail.alamatSekolah,
			kabkotSekolah: await _wilayah2023Option({ models, kode: dataSiswaSiswi.UserDetail.kabkotSekolah, bagian: 'kabkota' }),
			noPesertaUN: dataSiswaSiswi.UserDetail.noPesertaUN,
			noSKHUN: dataSiswaSiswi.UserDetail.noSKHUN,
			noIjazah: dataSiswaSiswi.UserDetail.noIjazah,
			nilaiUN: dataSiswaSiswi.UserDetail.nilaiUN,
		},
		noKK: dataSiswaSiswi.UserDetail.noKK,
		namaKK: dataSiswaSiswi.UserDetail.namaKK,
		dataOrangtua: {
			dataAyah: {
				namaAyah: dataSiswaSiswi.UserDetail.namaAyah,
				tahunAyah: dataSiswaSiswi.UserDetail.tahunAyah,
				statusAyah: await _allOptionCms(models, { where: { kode: 'statusorangtua' } }, { param: dataSiswaSiswi.UserDetail.statusAyah }),
				nikAyah: dataSiswaSiswi.UserDetail.nikAyah,
				pendidikanAyah: await _allOptionCms(models, { where: { kode: 'pendidikan' } }, { param: dataSiswaSiswi.UserDetail.pendidikanAyah }),
				pekerjaanAyah: await _allOptionCms(models, { where: { kode: 'pekerjaan' } }, { param: dataSiswaSiswi.UserDetail.pekerjaanAyah }),
				telpAyah: dataSiswaSiswi.UserDetail.telpAyah,
			},
			dataIbu: {
				namaIbu: dataSiswaSiswi.UserDetail.namaIbu,
				tahunIbu: dataSiswaSiswi.UserDetail.tahunIbu,
				statusIbu: await _allOptionCms(models, { where: { kode: 'statusorangtua' } }, { param: dataSiswaSiswi.UserDetail.statusIbu }),
				nikIbu: dataSiswaSiswi.UserDetail.nikIbu,
				pendidikanIbu: await _allOptionCms(models, { where: { kode: 'pendidikan' } }, { param: dataSiswaSiswi.UserDetail.pendidikanIbu }),
				pekerjaanIbu: await _allOptionCms(models, { where: { kode: 'pekerjaan' } }, { param: dataSiswaSiswi.UserDetail.pekerjaanIbu }),
				telpIbu: dataSiswaSiswi.UserDetail.telpIbu,
			},
			dataWali: {
				namaWali: dataSiswaSiswi.UserDetail.namaWali,
				tahunWali: dataSiswaSiswi.UserDetail.tahunWali,
				nikWali: dataSiswaSiswi.UserDetail.nikWali,
				pendidikanWali: dataSiswaSiswi.UserDetail.pendidikanWali ? await _allOptionCms(models, { where: { kode: 'pendidikan' } }, { param: dataSiswaSiswi.UserDetail.pendidikanWali }) : null,
				pekerjaanWali: dataSiswaSiswi.UserDetail.pekerjaanWali ? await _allOptionCms(models, { where: { kode: 'pekerjaan' } }, { param: dataSiswaSiswi.UserDetail.pekerjaanWali }) : null,
				telpWali: dataSiswaSiswi.UserDetail.telpWali,
			}
		},
		penghasilan: dataSiswaSiswi.UserDetail.penghasilan ? await _allOptionCms(models, { where: { kode: 'penghasilan' } }, { param: dataSiswaSiswi.UserDetail.penghasilan }) : null,
		dataAlamatOrangtua: {
			telp: dataSiswaSiswi.UserDetail.telp,
			alamat: dataSiswaSiswi.UserDetail.alamat,
			provinsi: await _wilayah2023Option({ models, kode: dataSiswaSiswi.UserDetail.provinsi, bagian: 'provinsi' }),
			kabKota: await _wilayah2023Option({ models, kode: dataSiswaSiswi.UserDetail.kabKota, bagian: 'kabkota' }),
			kecamatan: await _wilayah2023Option({ models, kode: dataSiswaSiswi.UserDetail.kecamatan, bagian: 'kecamatan' }),
			kelurahan: await _wilayah2023Option({ models, kode: dataSiswaSiswi.UserDetail.kelurahan, bagian: 'keldes' }),
			kodePos: dataSiswaSiswi.UserDetail.kodePos,
		},
		kelas: dataSiswaSiswi.UserDetail.kelas,
		dataLainnya: {
			statusTempatTinggal: dataSiswaSiswi.UserDetail.statusTempatTinggal ? await _allOptionCms(models, { where: { kode: 'statustempattinggal' } }, { param: dataSiswaSiswi.UserDetail.statusTempatTinggal }) : null,
			jarakRumah: dataSiswaSiswi.UserDetail.jarakRumah ? await _allOptionCms(models, { where: { kode: 'jarakrumah' } }, { param: dataSiswaSiswi.UserDetail.jarakRumah }) : null,
			transportasi: dataSiswaSiswi.UserDetail.transportasi ? await _allOptionCms(models, { where: { kode: 'transportasi' } }, { param: dataSiswaSiswi.UserDetail.transportasi }) : null,
		},
		fotoProfil: dataSiswaSiswi.UserDetail.fotoProfil ? `${BASE_URL}image/${dataSiswaSiswi.UserDetail.fotoProfil}` : `${BASE_URL}bahan/user.png`,
		mapel,
		berkas: {
			fcIjazah: dataSiswaSiswi.UserDetail.fcIjazah ? `${BASE_URL}pdf/${dataSiswaSiswi.UserDetail.fcIjazah}` : null,
			fcSKHUN: dataSiswaSiswi.UserDetail.fcSKHUN ? `${BASE_URL}pdf/${dataSiswaSiswi.UserDetail.fcSKHUN}` : null,
			fcKK: dataSiswaSiswi.UserDetail.fcKK ? `${BASE_URL}pdf/${dataSiswaSiswi.UserDetail.fcKK}` : null,
			fcKTPOrtu: dataSiswaSiswi.UserDetail.fcKTPOrtu ? `${BASE_URL}pdf/${dataSiswaSiswi.UserDetail.fcKTPOrtu}` : null,
			fcAktaLahir: dataSiswaSiswi.UserDetail.fcAktaLahir ? `${BASE_URL}pdf/${dataSiswaSiswi.UserDetail.fcAktaLahir}` : null,
			fcSKL: dataSiswaSiswi.UserDetail.fcSKL ? `${BASE_URL}pdf/${dataSiswaSiswi.UserDetail.fcSKL}` : null,
		},
		mutasiAkun: dataSiswaSiswi.mutasiAkun,
		validasiAkun: dataSiswaSiswi.validasiAkun,
		isActive: dataSiswaSiswi.isActive,
		statusAktif: dataSiswaSiswi.statusAktif,
	}
}

module.exports = {
  _buildResponseUser,
  _buildResponseAdmin,
  _buildResponseStruktural,
  _buildResponseSiswaSiswi,
}